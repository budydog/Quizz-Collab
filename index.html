/*
* =================================================================
* LÓGICA DE INTERAÇÃO PARA O DIAGNÓSTICO 2BRANDS (COM FEEDBACK DUPLO)
* =================================================================
*/

document.addEventListener('DOMContentLoaded', () => {

    // --- ESTRUTURA DE DADOS DO QUIZ (MODIFICADA) ---
    const quizData = [
        {
            question: "Além da sobreposição de público-alvo, qual é o critério mais crucial para garantir a autenticidade e o sucesso de uma collab?",
            options: ["Potencial de viralização", "Alinhamento de valores e propósito de marca", "Orçamento de marketing do parceiro", "Número de seguidores do parceiro"],
            correctAnswerIndex: 1,
            feedback: {
                correct: "Correto! O alinhamento de valores é a base que sustenta a credibilidade da parceria a longo prazo.",
                incorrect: "Quase lá. Embora a viralização seja ótima, o alinhamento de valores é o que garante que a parceria pareça autêntica e não apenas uma 'caça-cliques'."
            }
        },
        {
            question: "Para uma collab focada em fortalecer o capital de marca, quais desta métricas é a mais relevante?",
            options: ["Vendas diretas do produto", "Custo por Clique (CPC) nos anúncios", "Análise de Sentimento e 'Share of Voice'", "Taxa de abertura de e-mail marketing"],
            correctAnswerIndex: 2,
            feedback: {
                correct: "Correto! Brand Equity é medido pela percepção da marca, tornando a análise de sentimento o indicador mais direto.",
                incorrect: "Não exatamente. Vendas são importantes (ROI), mas o *Brand Equity* (valor da marca) é medido pela *percepção* e sentimento do público."
            }
        },
        {
            question: "Qual é o principal diferencial de um modelo de 'Colaboração' em relação a um simples 'Licenciamento'?",
            options: ["Colaboração é sempre mais barato", "Licenciamento envolve apenas o logo, Colaboração envolve o produto", "Colaboração implica na criação de um produto/serviço novo e conjunto", "Apenas marcas de luxo fazem Colaborações"],
            correctAnswerIndex: 2,
            feedback: {
                correct: "Exato! Licenciamento é 'alugar' a marca, Colaboração é 'criar junto', gerando valor mútuo e inovação.",
                incorrect: "Na verdade, o licenciamento é apenas o uso da marca, enquanto o colaboração envolve duas marcas se unindo para criar um produto novo e compartilhado."
            }
        },
        {
            question: "Ao negociar uma parceria, qual é o erro mais comum que as marcas 'iniciantes' cometem?",
            options: ["Focar excessivamente na divisão de receita imediata", "Ser transparente demais sobre suas fraquezas", "Pedir garantias legais excessivas", "Não ter um plano de marketing definido"],
            correctAnswerIndex: 0,
            feedback: {
                correct: "Precisamente. Muitas focam no ganho de curto prazo e esquecem o valor estratégico (awareness, posicionamento) que é o maior ativo de uma boa collab.",
                incorrect: "Pense de novo. O erro mais comum é focar apenas no dinheiro imediato (receita) e esquecer o valor estratégico de longo prazo, como o ganho de audiência e posicionamento."
            }
        },
        {
            question: "Qual elemento é fundamental para garantir que uma das marcas participantes da collab não 'canibalize' o público da outra?",
            options: ["Lançar em datas completamente diferentes", "Usar exatamente a mesma comunicação", "Uma clara definição de 'storytelling' que una as duas marcas", "Oferecer o produto apenas para clientes existentes"],
            correctAnswerIndex: 2,
            feedback: {
                correct: "Correto! O 'storytelling' é a cola que justifica a parceria para o público, mostrando por que as duas marcas fazem sentido juntas.",
                incorrect: "Não é bem por aí. A 'cola' que une as marcas e evita a canibalização é um bom 'storytelling', que explica ao público *por que* essa parceria faz sentido."
            }
        }
    ];

    // --- VARIÁVEIS DE ESTADO ---
    let currentQuestionIndex = 0;
    let score = 0;

    // --- SELETORES DE ELEMENTOS DOM ---
    const startButton = document.querySelector('.cta-button[href="#quiz-section"]');
    const quizSection = document.getElementById('quiz-section');
    const resultsSection = document.getElementById('results-section');
    const questionText = document.getElementById('question-text');
    const answerOptions = document.getElementById('answer-options');
    const feedbackText = document.getElementById('feedback-text');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const leadForm = document.getElementById('lead-form');
    const nextQuestionButton = document.getElementById('next-question-button');

    // --- FUNÇÕES PRINCIPAIS ---

    function startQuiz(event) {
        event.preventDefault();
        quizSection.classList.remove('hidden');
        quizSection.scrollIntoView({ behavior: 'smooth' });
        displayQuestion();
        gtag('event', 'quiz_start');
    }

    function displayQuestion() {
        const currentQuestion = quizData[currentQuestionIndex];
        questionText.innerHTML = currentQuestion.question;

        answerOptions.innerHTML = '';
        feedbackText.innerHTML = '';

        nextQuestionButton.classList.add('hidden');
        
        currentQuestion.options.forEach((option, index) => {
            const optionElement = document.createElement('button');
            optionElement.classList.add('answer-option');
            optionElement.innerHTML = option;
            optionElement.dataset.index = index;
            optionElement.addEventListener('click', selectAnswer);
            answerOptions.appendChild(optionElement);
        });

        const progressPercent = ((currentQuestionIndex + 1) / quizData.length) * 100;
        progressBar.style.width = `${progressPercent}%`;
        progressText.innerHTML = `Pergunta ${currentQuestionIndex + 1} de ${quizData.length}`;
    }

    /**
     * Lida com a seleção de uma resposta.
     */
    function selectAnswer(event) {
        const selectedIndex = parseInt(event.target.dataset.index);
        const correctIndex = quizData[currentQuestionIndex].correctAnswerIndex;
        const currentFeedback = quizData[currentQuestionIndex].feedback;

        // *** CORREÇÃO 1: Definimos a variável 'isCorrect' aqui ***
        const isCorrect = (selectedIndex === correctIndex);

        const allOptions = document.querySelectorAll('.answer-option');
        allOptions.forEach(option => option.classList.add('disabled'));

        // LÓGICA DE FEEDBACK
        if (isCorrect) { // Usamos a variável
            score++;
            event.target.classList.add('correct');
            feedbackText.innerHTML = currentFeedback.correct;
        } else {
            event.target.classList.add('incorrect');
            allOptions[correctIndex].classList.add('correct');
            feedbackText.innerHTML = currentFeedback.incorrect;
        }

        // *** CORREÇÃO 2: A chamada 'gtag' foi fechada com '});' ***
        gtag('event', 'answer_selected', {
            'question_number': currentQuestionIndex + 1, // Envia o nº da pergunta
            'is_correct': isCorrect, // Envia true ou false (agora 'isCorrect' existe)
            'selected_option': selectedIndex // Envia qual opção ele marcou
        });

        // --- O restante da lógica permanece o mesmo ---

        // Verifica se é a última pergunta para mudar o texto do botão
        if (currentQuestionIndex === quizData.length - 1) {
            nextQuestionButton.innerHTML = "Ver Resultados";
        } else {
            nextQuestionButton.innerHTML = "Próxima Pergunta";
        }
        
        // Mostra o botão
        nextQuestionButton.classList.remove('hidden');
    }

    /**
     * FUNÇÃO PARA AVANÇAR: Chamada ao clicar no botão "Próxima Pergunta".
     */
    function goToNextQuestion() {
        currentQuestionIndex++;

        if (currentQuestionIndex < quizData.length) {
            displayQuestion();
        } else {
            showResults();
        }
    }

    /**
     * Calcula e exibe a seção de resultados.
     */
    function showResults() {
        quizSection.classList.add('hidden');
        resultsSection.classList.remove('hidden');

        let segment, headline, text;

        if (score <= 3) {
            segment = 'Explorador';
            headline = `Você acertou ${score} de 5. Sua jornada no universo das collabs está apenas começando.`;
            text = "Identificar o potencial é o primeiro passo. O próximo é construir a estratégia correta. O universo das parcerias é vasto e cheio de nuances, e estamos aqui para ser o seu guia em cada etapa.";
        } else {
            segment = 'Estrategista';
            headline = `Excelente! Você acertou ${score} de 5, mostrando um conhecimento avançado sobre collabs.`;
            text = "Você já entende a teoria e os mecanismos por trás de uma parceria de sucesso. Agora, o desafio é a execução: encontrar o parceiro ideal, navegar as negociações e garantir um ROI real. Vamos acelerar esse processo.";
        }
        
        gtag('event', 'quiz_complete', {
            'final_score': score, // Envia a pontuação final
            'user_segment': segment // Envia o perfil (Explorador/Estrategista)
        });

        document.getElementById('result-headline').innerHTML = headline;
        document.getElementById('result-text').innerHTML = text;
        document.getElementById('hidden-segment').value = segment;
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // --- OUVINTES DE EVENTOS (EVENT LISTENERS) ---
    startButton.addEventListener('click', startQuiz);
    nextQuestionButton.addEventListener('click', goToNextQuestion);
    
    leadForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Impede o recarregamento da página
        
        const submitButton = leadForm.querySelector('button[type="submit"]');
        const formData = new FormData(leadForm); // Pega todos os dados do formulário
        
        // Mostra um feedback de "Enviando..."
        submitButton.disabled = true;
        submitButton.innerHTML = "Enviando...";

        // Usa o Fetch para enviar os dados para o Formspree
        fetch(leadForm.action, {
            method: leadForm.method,
            body: formData,
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            // Se deu certo, mostra o "Obrigado"
            if (response.ok) {
                submitButton.innerHTML = "Obrigado! Em breve entraremos em contato.";
                leadForm.reset(); // Limpa o formulário
                gtag('event', 'form_submit', { 'form_name': 'leads' });
            } else {
                // Se deu erro na rede
                submitButton.disabled = false;
                submitButton.innerHTML = "Ocorreu um erro. Tente novamente.";
            }
        })
        .catch(error => {
            // Se deu qualquer outro erro
            submitButton.disabled = false;
            submitButton.innerHTML = "Ocorreu um erro. Tente novamente.";
        });
    });

});
